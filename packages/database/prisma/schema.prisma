// ──────────────────────────────────────────────────────────────
// Growth OS — Prisma Schema
// Full data model: raw layer, staging, marts, orchestration
// ──────────────────────────────────────────────────────────────

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════════════════════════════════
// RAW LAYER
// ══════════════════════════════════════════════════════════════

model RawEvent {
  id          String   @id @default(uuid())
  source      String   // shopify | meta | google_ads | ga4
  entity      String   // orders | customers | campaigns | insights | sessions
  externalId  String?  @map("external_id")
  cursor      String?  // pagination cursor or updated_at watermark
  fetchedAt   DateTime @default(now()) @map("fetched_at")
  payloadJson Json     @map("payload_json")

  @@index([source, entity])
  @@index([source, entity, externalId])
  @@index([fetchedAt])
  @@map("raw_events")
}

model JobRun {
  id          String    @id @default(uuid())
  jobName     String    @map("job_name")
  status      JobStatus @default(PENDING)
  startedAt   DateTime  @default(now()) @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  rowsLoaded  Int       @default(0) @map("rows_loaded")
  errorJson   Json?     @map("error_json")
  durationMs  Int?      @map("duration_ms")
  metadata    Json?     // extra context: source, entity, cursor range, etc.

  @@index([jobName, startedAt])
  @@index([status])
  @@map("job_runs")
}

enum JobStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  RETRYING
}

// ══════════════════════════════════════════════════════════════
// CREDENTIAL STORAGE (encrypted at rest)
// ══════════════════════════════════════════════════════════════

model ConnectorCredential {
  id            String   @id @default(uuid())
  connectorType String   @map("connector_type") // shopify | google | meta
  encryptedData String   @map("encrypted_data") // AES-GCM encrypted JSON
  iv            String   // initialization vector
  authTag       String   @map("auth_tag") // GCM auth tag
  metadata      Json?    // non-sensitive config (shop domain, property id, etc.)
  lastSyncAt    DateTime? @map("last_sync_at")
  lastSyncStatus String? @map("last_sync_status")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([connectorType])
  @@map("connector_credentials")
}

// ══════════════════════════════════════════════════════════════
// STAGING LAYER
// ══════════════════════════════════════════════════════════════

model StgOrder {
  id              String    @id @default(uuid())
  orderId         String    @unique @map("order_id") // Shopify order ID
  orderDate       DateTime  @map("order_date")
  customerId      String?   @map("customer_id")
  email           String?
  revenueGross    Decimal   @map("revenue_gross") @db.Decimal(12, 2)
  discounts       Decimal   @default(0) @db.Decimal(12, 2)
  refunds         Decimal   @default(0) @db.Decimal(12, 2)
  revenueNet      Decimal   @map("revenue_net") @db.Decimal(12, 2)
  currency        String    @default("USD")
  sourceName      String?   @map("source_name")
  landingSite     String?   @map("landing_site")
  referringSite   String?   @map("referring_site")
  utmSource       String?   @map("utm_source")
  utmMedium       String?   @map("utm_medium")
  utmCampaign     String?   @map("utm_campaign")
  channelRaw      String?   @map("channel_raw")
  region          String?
  lineItemsJson   Json?     @map("line_items_json")
  isNewCustomer   Boolean   @default(false) @map("is_new_customer")
  paymentMethod   String?   @map("payment_method")
  paymentStatus   String?   @map("payment_status")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([orderDate])
  @@index([customerId])
  @@map("stg_orders")
}

model StgCustomer {
  id                  String   @id @default(uuid())
  customerId          String   @unique @map("customer_id")
  email               String?
  firstOrderDate      DateTime? @map("first_order_date")
  acquisitionChannel  String?  @map("acquisition_channel")
  region              String?
  totalOrders         Int      @default(0) @map("total_orders")
  totalRevenue        Decimal  @default(0) @db.Decimal(12, 2) @map("total_revenue")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("stg_customers")
}

model StgSpend {
  id           String   @id @default(uuid())
  date         DateTime @db.Date
  source       String   // meta | google_ads
  campaignId   String   @map("campaign_id")
  campaignName String   @map("campaign_name")
  spend        Decimal  @db.Decimal(12, 2)
  impressions  Int      @default(0)
  clicks       Int      @default(0)
  conversions  Int      @default(0)
  conversionValue Decimal @default(0) @db.Decimal(12, 2) @map("conversion_value")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([date, source, campaignId])
  @@index([date])
  @@map("stg_spend")
}

model StgTraffic {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  source      String   // ga4
  channelRaw  String?  @map("channel_raw")
  sessions    Int      @default(0)
  pdpViews    Int      @default(0) @map("pdp_views")
  addToCart   Int      @default(0) @map("add_to_cart")
  checkouts   Int      @default(0)
  purchases   Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([date, source, channelRaw])
  @@index([date])
  @@map("stg_traffic")
}

model StgEmail {
  id             String   @id @default(uuid())
  date           DateTime @db.Date
  source         String   // klaviyo
  campaignId     String   @map("campaign_id")
  campaignName   String   @map("campaign_name")
  campaignType   String   @map("campaign_type") // campaign | flow
  sends          Int      @default(0)
  opens          Int      @default(0)
  clicks         Int      @default(0)
  bounces        Int      @default(0)
  unsubscribes   Int      @default(0)
  conversions    Int      @default(0)
  revenue        Decimal  @default(0) @db.Decimal(12, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  @@unique([date, source, campaignId], map: "stg_email_date_source_campaign")
  @@index([date])
  @@map("stg_email")
}

// ══════════════════════════════════════════════════════════════
// MART / SEMANTIC LAYER — DIMENSIONS
// ══════════════════════════════════════════════════════════════

model DimDate {
  date      DateTime @id @db.Date
  dayOfWeek Int      @map("day_of_week")
  dayName   String   @map("day_name")
  week      Int
  month     Int
  monthName String   @map("month_name")
  quarter   Int
  year      Int
  isWeekend Boolean  @map("is_weekend")

  @@map("dim_date")
}

model DimChannel {
  id   String @id @default(uuid())
  slug String @unique // meta, google, email, organic, affiliate, direct, other
  name String         // Meta Ads, Google Ads, Email, Organic, Affiliate, Direct, Other

  factOrders FactOrder[]
  factSpend  FactSpend[]
  factTraffic FactTraffic[]
  factEmail   FactEmail[]
  dimCampaigns DimCampaign[]

  @@map("dim_channel")
}

model DimCampaign {
  id           String  @id @default(uuid())
  source       String  // meta | google_ads
  campaignId   String  @map("campaign_id")
  campaignName String  @map("campaign_name")
  channelId    String  @map("channel_id")
  channel      DimChannel @relation(fields: [channelId], references: [id])

  factOrders FactOrder[]
  factSpend  FactSpend[]
  factEmail  FactEmail[]

  @@unique([source, campaignId])
  @@map("dim_campaign")
}

model DimCustomer {
  id                  String    @id @default(uuid())
  customerId          String    @unique @map("customer_id")
  firstOrderDate      DateTime? @map("first_order_date") @db.Date
  acquisitionChannel  String?   @map("acquisition_channel")
  region              String?
  isNewCustomer       Boolean   @default(true) @map("is_new_customer")
  cohortMonth         String?   @map("cohort_month") // YYYY-MM
  totalOrders         Int       @default(0) @map("total_orders")
  totalRevenue        Decimal   @default(0) @db.Decimal(12, 2) @map("total_revenue")
  ltv30               Decimal   @default(0) @db.Decimal(12, 2)
  ltv90               Decimal   @default(0) @db.Decimal(12, 2)
  ltv180              Decimal   @default(0) @db.Decimal(12, 2)
  lastOrderDate       DateTime? @map("last_order_date") @db.Date
  rfmRecency          Int?      @map("rfm_recency")
  rfmFrequency        Int?      @map("rfm_frequency")
  rfmMonetary         Int?      @map("rfm_monetary")
  segment             String?

  factOrders FactOrder[]

  @@map("dim_customer")
}

// ══════════════════════════════════════════════════════════════
// MART / SEMANTIC LAYER — FACTS
// ══════════════════════════════════════════════════════════════

model FactOrder {
  id                  String   @id @default(uuid())
  orderId             String   @unique @map("order_id")
  orderDate           DateTime @map("order_date") @db.Date
  customerId          String?  @map("customer_id")
  customer            DimCustomer? @relation(fields: [customerId], references: [customerId])
  revenueGross        Decimal  @map("revenue_gross") @db.Decimal(12, 2)
  discounts           Decimal  @default(0) @db.Decimal(12, 2)
  refunds             Decimal  @default(0) @db.Decimal(12, 2)
  revenueNet          Decimal  @map("revenue_net") @db.Decimal(12, 2)
  cogs                Decimal  @default(0) @db.Decimal(12, 2)
  shippingCost        Decimal  @default(0) @map("shipping_cost") @db.Decimal(12, 2)
  opsCost             Decimal  @default(0) @map("ops_cost") @db.Decimal(12, 2)
  contributionMargin  Decimal  @default(0) @map("contribution_margin") @db.Decimal(12, 2)
  channelId           String?  @map("channel_id")
  channel             DimChannel? @relation(fields: [channelId], references: [id])
  campaignId          String?  @map("campaign_id")
  campaign            DimCampaign? @relation(fields: [campaignId], references: [id])
  category            String?
  region              String?
  isNewCustomer       Boolean  @default(false) @map("is_new_customer")
  paymentMethod       String?  @map("payment_method")
  paymentStatus       String?  @map("payment_status")

  @@index([orderDate])
  @@index([channelId])
  @@index([customerId])
  @@map("fact_orders")
}

model FactSpend {
  id          String   @id @default(uuid())
  date        DateTime @db.Date
  channelId   String   @map("channel_id")
  channel     DimChannel @relation(fields: [channelId], references: [id])
  campaignId  String?  @map("campaign_id")
  campaign    DimCampaign? @relation(fields: [campaignId], references: [id])
  spend       Decimal  @db.Decimal(12, 2)
  impressions Int      @default(0)
  clicks      Int      @default(0)

  @@unique([date, channelId, campaignId])
  @@index([date])
  @@map("fact_spend")
}

model FactTraffic {
  id        String   @id @default(uuid())
  date      DateTime @db.Date
  channelId String   @map("channel_id")
  channel   DimChannel @relation(fields: [channelId], references: [id])
  sessions  Int      @default(0)
  pdpViews  Int      @default(0) @map("pdp_views")
  addToCart Int      @default(0) @map("add_to_cart")
  checkouts Int     @default(0)
  purchases Int      @default(0)

  @@unique([date, channelId])
  @@index([date])
  @@map("fact_traffic")
}

model FactEmail {
  id             String       @id @default(uuid())
  date           DateTime     @db.Date
  channelId      String       @map("channel_id")
  channel        DimChannel   @relation(fields: [channelId], references: [id])
  campaignId     String?      @map("campaign_id")
  campaign       DimCampaign? @relation(fields: [campaignId], references: [id])
  sends          Int          @default(0)
  opens          Int          @default(0)
  clicks         Int          @default(0)
  bounces        Int          @default(0)
  unsubscribes   Int          @default(0)
  conversions    Int          @default(0)
  revenue        Decimal      @default(0) @db.Decimal(12, 2)
  openRate       Decimal?     @map("open_rate") @db.Decimal(5, 4)
  clickRate      Decimal?     @map("click_rate") @db.Decimal(5, 4)
  conversionRate Decimal?     @map("conversion_rate") @db.Decimal(5, 4)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([date, channelId, campaignId], map: "fact_email_date_channel_campaign")
  @@index([date])
  @@map("fact_email")
}

model Cohort {
  id           String   @id @default(uuid())
  cohortMonth  String   @unique @map("cohort_month") // YYYY-MM
  cohortSize   Int      @map("cohort_size")
  d7Retention  Decimal  @default(0) @map("d7_retention") @db.Decimal(5, 4)
  d30Retention Decimal  @default(0) @map("d30_retention") @db.Decimal(5, 4)
  d60Retention Decimal  @default(0) @map("d60_retention") @db.Decimal(5, 4)
  d90Retention Decimal  @default(0) @map("d90_retention") @db.Decimal(5, 4)
  ltv30        Decimal  @default(0) @db.Decimal(12, 2)
  ltv90        Decimal  @default(0) @db.Decimal(12, 2)
  ltv180       Decimal  @default(0) @db.Decimal(12, 2)
  paybackDays  Int?     @map("payback_days")
  avgCac       Decimal? @default(0) @map("avg_cac") @db.Decimal(12, 2)

  @@map("cohorts")
}

// ══════════════════════════════════════════════════════════════
// EXPERIMENTATION
// ══════════════════════════════════════════════════════════════

enum ExperimentStatus {
  IDEA
  BACKLOG
  RUNNING
  COMPLETED
  ARCHIVED
}

model Experiment {
  id            String           @id @default(uuid())
  name          String
  hypothesis    String           @db.Text
  status        ExperimentStatus @default(IDEA)
  channel       String?
  primaryMetric String           @map("primary_metric")
  targetLift    Float?           @map("target_lift")

  // ICE scoring
  impact     Int?
  confidence Int?
  ease       Int?
  iceScore   Float?  @map("ice_score")

  startDate  DateTime? @map("start_date")
  endDate    DateTime? @map("end_date")
  result     String?   @db.Text
  learnings  String?   @db.Text
  nextSteps  String?   @db.Text @map("next_steps")

  // A/B test variant metadata
  controlName         String?  @map("control_name")
  variantName         String?  @map("variant_name")

  // A/B test sample data (user-provided)
  controlSampleSize   Int?     @map("control_sample_size")
  variantSampleSize   Int?     @map("variant_sample_size")
  controlConversions  Int?     @map("control_conversions")
  variantConversions  Int?     @map("variant_conversions")

  // A/B test computed results (auto-computed on save)
  controlRate         Float?   @map("control_rate")
  variantRate         Float?   @map("variant_rate")
  absoluteLift        Float?   @map("absolute_lift")
  relativeLift        Float?   @map("relative_lift")
  pValue              Float?   @map("p_value")
  confidenceLevel     Float?   @map("confidence_level")
  isSignificant       Boolean? @map("is_significant")
  confidenceInterval  Json?    @map("confidence_interval")
  verdict             String?

  metrics    ExperimentMetric[]

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt     @map("updated_at")

  @@index([status])
  @@index([channel])
  @@map("experiments")
}

model ExperimentMetric {
  id           String     @id @default(uuid())
  experimentId String     @map("experiment_id")
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  date         DateTime
  metricName   String     @map("metric_name")
  value        Float
  notes        String?

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([experimentId, date, metricName], map: "experiment_date_metric")
  @@map("experiment_metrics")
}

// ══════════════════════════════════════════════════════════════
// AI SUGGESTION ENGINE
// ══════════════════════════════════════════════════════════════

enum OpportunityType {
  EFFICIENCY_DROP
  CAC_SPIKE
  RETENTION_DECLINE
  FUNNEL_LEAK
  GROWTH_PLATEAU
  CHANNEL_IMBALANCE
  QUICK_WIN
}

enum OpportunityStatus {
  NEW
  REVIEWED
  ACTED
  DISMISSED
}

enum SuggestionType {
  AI_GENERATED
  PLAYBOOK_MATCH
  RULE_BASED
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
  PROMOTED
}

enum FeedbackAction {
  APPROVE
  REJECT
  MODIFY
  PROMOTE
}

model Opportunity {
  id          String            @id @default(uuid())
  type        OpportunityType
  title       String
  description String            @db.Text
  priority    Int               @default(50)
  status      OpportunityStatus @default(NEW)
  signalsJson Json              @map("signals_json")
  suggestions Suggestion[]
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt      @map("updated_at")

  @@index([status])
  @@index([type])
  @@map("opportunities")
}

model Suggestion {
  id                  String             @id @default(uuid())
  opportunityId       String             @map("opportunity_id")
  opportunity         Opportunity        @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  type                SuggestionType     @default(AI_GENERATED)
  title               String
  hypothesis          String             @db.Text
  suggestedChannel    String?            @map("suggested_channel")
  suggestedMetric     String?            @map("suggested_metric")
  suggestedTargetLift Float?             @map("suggested_target_lift")
  impactScore         Int?               @map("impact_score")
  confidenceScore     Int?               @map("confidence_score")
  effortScore         Int?               @map("effort_score")
  riskScore           Int?               @map("risk_score")
  reasoning           String?            @db.Text
  playbookRef         String?            @map("playbook_ref")
  status              SuggestionStatus   @default(PENDING)
  feedback            SuggestionFeedback[]
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt      @map("updated_at")

  @@index([opportunityId])
  @@index([status])
  @@map("suggestions")
}

model SuggestionFeedback {
  id                   String         @id @default(uuid())
  suggestionId         String         @map("suggestion_id")
  suggestion           Suggestion     @relation(fields: [suggestionId], references: [id], onDelete: Cascade)
  action               FeedbackAction
  notes                String?        @db.Text
  promotedExperimentId String?        @map("promoted_experiment_id")
  createdAt            DateTime       @default(now()) @map("created_at")

  @@index([suggestionId])
  @@map("suggestion_feedback")
}

// ══════════════════════════════════════════════════════════════
// GROWTH MODEL / SCENARIO PLANNING
// ══════════════════════════════════════════════════════════════

model GrowthScenario {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  isBaseline  Boolean  @default(false) @map("is_baseline")

  // Input assumptions
  monthlyBudget        Float  @map("monthly_budget")
  targetCac            Float  @map("target_cac")
  expectedCvr          Float  @map("expected_cvr")
  avgOrderValue        Float  @map("avg_order_value")
  cogsPercent          Float  @map("cogs_percent")
  monthlyTraffic       Int?   @map("monthly_traffic")
  returnRate           Float  @default(0) @map("return_rate")
  avgOrdersPerCustomer Float  @default(1) @map("avg_orders_per_customer")
  horizonMonths        Int    @default(6) @map("horizon_months")

  // Computed outputs (stored for quick listing)
  projectedRevenue            Float  @map("projected_revenue")
  projectedOrders             Int    @map("projected_orders")
  projectedCustomers          Int    @map("projected_customers")
  projectedRoas               Float  @map("projected_roas")
  projectedMer                Float  @map("projected_mer")
  projectedLtv                Float  @map("projected_ltv")
  projectedContributionMargin Float  @map("projected_contribution_margin")
  breakEvenMonth              Int?   @map("break_even_month")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@map("growth_scenarios")
}

// ══════════════════════════════════════════════════════════════
// APP SETTINGS (persistent key-value store)
// ══════════════════════════════════════════════════════════════

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("app_settings")
}
